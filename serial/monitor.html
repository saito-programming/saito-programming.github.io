<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒªã‚¢ãƒ«é€šä¿¡ãƒ¢ãƒ‹ã‚¿ãƒ¼ - Saito Programming Hub</title>
    <link rel="stylesheet" href="/css/monitor.css">
</head>
<body>

    <h1>ãƒã‚¤ã‚¯ãƒ­ãƒ“ãƒƒãƒˆã‚·ãƒªã‚¢ãƒ«é€šä¿¡ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>
    <button id="connect">ãƒã‚¤ã‚¯ãƒ­ãƒ“ãƒƒãƒˆã«æ¥ç¶šã™ã‚‹(baudRateï¼š115200bps)</button>

    <div id="output">
        <p style="color: #888;">ã“ã“ã«å—ä¿¡ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™...</p>
    </div>

    <div>
    	<a href="/">æˆ»ã‚‹</a>
    </div>

    <script>
        const connectBtn = document.getElementById('connect');
        const outputDiv = document.getElementById('output');

        connectBtn.addEventListener('click', async () => {
            try {
                // ã‚·ãƒªã‚¢ãƒ«ãƒãƒ¼ãƒˆã®è¦æ±‚
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });

                connectBtn.textContent = "ğŸ”Œ æ¥ç¶šä¸­...";
                connectBtn.disabled = true;
                outputDiv.innerHTML = ""; // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆå»

                const decoder = new TextDecoderStream();
                port.readable.pipeTo(decoder.writable);
                const reader = decoder.readable.getReader();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    if (value) {
                        // micro:bitã‹ã‚‰ã®æ–‡å­—åˆ—ã‚’è¡¨ç¤ºï¼ˆæ”¹è¡Œã‚³ãƒ¼ãƒ‰ãªã©ã®ãƒˆãƒªãƒŸãƒ³ã‚°ï¼‰
                        const cleanText = value.trim();
                        if (cleanText) {
                            const p = document.createElement('p');
                            p.className = 'log-line';
                            p.innerHTML = `<span class="tag">[å—ä¿¡]</span>${cleanText}`;
                            outputDiv.appendChild(p);
                            
                            // å¸¸ã«æœ€æ–°ã®è¡ŒãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                            outputDiv.scrollTop = outputDiv.scrollHeight;
                        }
                    }
                }
            } catch (error) {
                console.error(error);
                alert("æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        });
    </script>
</body>
</html>
