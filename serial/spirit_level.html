<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒªã‚¢ãƒ«æ°´æº–å™¨ãƒ¢ãƒ‹ã‚¿ãƒ¼</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            margin: 0;
        }
        #connect { padding: 10px 20px; font-size: 1.2rem; cursor: pointer;  border-radius: 5px; border: none;background: #0078d7; color: white; }
        #display-area {
            width: 600px;
            height: 400px;
            background-color: #000;
            border: 4px solid #333;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            margin: 20px 0 20px 0;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        #sphere {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle at 30% 30%, #ff5f5f, #aa0000);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: top 0.1s, left 0.1s;
        }
        .controls {
            background: white;
            padding: 20px;
            margin:0 0 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

    <h1>ã‚·ãƒªã‚¢ãƒ«æ°´æº–å™¨ãƒ¢ãƒ‹ã‚¿ãƒ¼</h1>
    <button id="connect">ãƒã‚¤ã‚¯ãƒ­ãƒ“ãƒƒãƒˆã«æ¥ç¶šã™ã‚‹(baudRateï¼š115200bps)</button>

    <div id="display-area">
        <div id="sphere"></div>
    </div>

    <div class="controls">
    	 [w,a,s,d]: ç§»å‹•
    </div>

    <div>
    	<a href="/">æˆ»ã‚‹</a>
    </div>

    <script>
        const sphere = document.getElementById('sphere');
        const connectBtn = document.getElementById('connect');
        const statusText = document.getElementById('status');

        let x = 50; // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆè¡¨ç¤ºç”¨
        let y = 50;
        const step = 5; // ç§»å‹•é‡

        // çƒä½“ã®ä½ç½®ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updatePosition(key) {
            if (key === 'w') y -= step;
            if (key === 's') y += step;
            if (key === 'a') x -= step;
            if (key === 'd') x += step;

            // ç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†ã«åˆ¶é™
            x = Math.max(5, Math.min(95, x));
            y = Math.max(5, Math.min(95, y));

            sphere.style.left = x + '%';
            sphere.style.top = y + '%';
        }

        // Web Serial API ã®å‡¦ç†
        connectBtn.addEventListener('click', async () => {
            try {
                const port = await navigator.serial.requestPort();
                await port.open({ baudRate: 115200 });
                
                connectBtn.textContent = "ğŸ”Œ æ¥ç¶šä¸­...";
                //connectBtn.style.display = "none";

                const reader = port.readable.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    const text = decoder.decode(value).trim().toLowerCase();
                    // æ–‡å­—åˆ—ã®ä¸­ã«w,a,s,dãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    for (let char of text) {
                        if (['w', 'a', 's', 'd'].includes(char)) {
                            updatePosition(char);
                        }
                    }
                }
            } catch (error) {
                console.error(error);
                statusText.innerText = "ã‚¨ãƒ©ãƒ¼: æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ";
            }
        });

        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã§ã®ãƒ†ã‚¹ãƒˆç”¨
        window.addEventListener('keydown', (e) => {
            updatePosition(e.key.toLowerCase());
        });
    </script>
</body>
</html>
